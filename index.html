<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>5-manna Fotbollsschema</title>
<style>
  body { font-family: Arial; max-width: 900px; margin: auto; padding: 20px; }
  h1 { text-align: center; }
  input, select, button { margin: 5px 0; padding: 5px; width: 100%; }
  .player-input { display: flex; gap: 10px; margin-bottom: 5px; }
  .halffield { width: 100%; height: 300px; background: #cce6ff; border: 2px solid #0077cc; margin: 20px 0; position: relative; }
  .player { width: 60px; height: 60px; border-radius: 50%; background: #ffcc00; display: flex; justify-content: center; align-items: center; font-weight: bold; position: absolute; text-align: center; }
  .gk { background: #ff6666; }
  .summary-table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  .summary-table th, .summary-table td { border: 1px solid #ccc; padding: 5px; text-align: center; }
  .arrow { font-weight: bold; font-size: 18px; }
  .green { color: green; }
  .red { color: red; }
</style>
</head>
<body>
<h1>5-manna Fotbollsschema</h1>

<h2>1. Ange spelare</h2>
<div id="playerInputs"></div>
<button onclick="createPlayerInputs()">Uppdatera spelarnamn</button>

<h2>2. Inställningar</h2>
<label>Antal perioder:</label>
<input type="number" id="periods" value="3" min="1">
<label>Periodlängd (minuter):</label>
<input type="number" id="periodLength" value="10" min="1">
<label>Minuter mellan byten:</label>
<input type="number" id="minInterval" value="7" min="1">

<h2>3. Målvakt per period</h2>
<div id="gkSelects"></div>

<h2>4. Startuppställning (halvplan)</h2>
<div class="halffield" id="halffield"></div>

<button onclick="generateSchedule()">Skapa schema</button>

<h2>Schema och byten</h2>
<div id="schedule"></div>

<h2>Summering</h2>
<div id="summary"></div>

<script>
let numPlayers = 8;
let playerInputs = [];

function createPlayerInputs() {
  const container = document.getElementById("playerInputs");
  container.innerHTML = '';
  playerInputs = [];
  for (let i = 0; i < numPlayers; i++) {
    let div = document.createElement("div");
    div.className = "player-input";
    let inp = document.createElement("input");
    inp.placeholder = `Spelare ${i+1}`;
    inp.id = `player${i}`;
    div.appendChild(inp);
    container.appendChild(div);
    playerInputs.push(inp);
    inp.addEventListener("input", updateGKSelects);
  }
  updateGKSelects();
}

function updateGKSelects() {
  const gkContainer = document.getElementById("gkSelects");
  gkContainer.innerHTML = '';
  const periods = parseInt(document.getElementById("periods").value);
  for (let p = 0; p < periods; p++) {
    let sel = document.createElement("select");
    sel.id = `gk${p}`;
    playerInputs.forEach((input, idx)=>{
      let opt = document.createElement("option");
      opt.value = idx;
      opt.text = input.value || input.placeholder;
      sel.appendChild(opt);
    });
    gkContainer.appendChild(document.createTextNode(`Period ${p+1}: `));
    gkContainer.appendChild(sel);
    gkContainer.appendChild(document.createElement("br"));
  }
}

function drawHalffield(startPlayers=[]) {
  const field = document.getElementById("halffield");
  field.innerHTML = '';
  if(startPlayers.length < 5) return;
  const positions = [
    {x:'45%', y:'80%'}, // GK
    {x:'20%', y:'60%'}, // Back 1
    {x:'70%', y:'60%'}, // Back 2
    {x:'30%', y:'30%'}, // Forward 1
    {x:'60%', y:'30%'}  // Forward 2
  ];
  startPlayers.forEach((p,i)=>{
    let div = document.createElement("div");
    div.className = 'player' + (i===0?' gk':'');
    div.style.left = positions[i].x;
    div.style.top = positions[i].y;
    div.innerText = p;
    field.appendChild(div);
  });
}

function generateSchedule() {
  const periods = parseInt(document.getElementById("periods").value);
  const periodLength = parseInt(document.getElementById("periodLength").value);
  const minInterval = parseInt(document.getElementById("minInterval").value);
  const players = playerInputs.map(inp=>inp.value || inp.placeholder);

  // Målvakter
  let gks = [];
  for (let p = 0; p < periods; p++) {
    let sel = document.getElementById(`gk${p}`);
    gks.push(parseInt(sel.value));
  }

  // Skapa spelardata
  let playerData = players.map((name, idx)=>({
    name,
    totalPlay: 0,
    lastSub: -minInterval,
    gkMinutes: gks.filter(g=>g===idx).length * periodLength
  }));

  // Utespelare index
  const utespelareIdx = [...Array(players.length).keys()].filter(i=>!gks.includes(i));

  // Beräkna önskad utespelartid
  const totalUtespelartid = periodLength*periods*4; // 4 utespelare på plan
  const avgUtespelartid = totalUtespelartid / utespelareIdx.length;

  // Startuppställning: första 4 utespelare
  let startField = utespelareIdx.slice(0,4);
  drawHalffield([players[gks[0]], ...startField.map(i=>players[i])]);

  let schedule = [];
  for (let p = 0; p < periods; p++) {
    let gk = gks[p];
    let fieldPlayers = startField.slice();
    let bench = utespelareIdx.filter(i=>!fieldPlayers.includes(i));

    for (let m=1; m<=periodLength; m++) {
      // Byten
      let outCandidates = fieldPlayers.filter(i=>{
        return m + p*periodLength - playerData[i].lastSub >= minInterval &&
               playerData[i].totalPlay > avgUtespelartid;
      });
      let inCandidates = bench.filter(i=>{
        return m + p*periodLength - playerData[i].lastSub >= minInterval &&
               playerData[i].totalPlay < avgUtespelartid;
      });

      let subsNum = Math.min(2, outCandidates.length, inCandidates.length);
      let subsOut = outCandidates.slice(0, subsNum);
      let subsIn = inCandidates.slice(0, subsNum);

      fieldPlayers = fieldPlayers.filter(f=>!subsOut.includes(f)).concat(subsIn);
      bench = bench.filter(b=>!subsIn.includes(b)).concat(subsOut);

      subsIn.forEach(i=>playerData[i].lastSub = m + p*periodLength);
      subsOut.forEach(i=>playerData[i].lastSub = m + p*periodLength);

      // Uppdatera speltid (utespelartid)
      fieldPlayers.forEach(i=>playerData[i].totalPlay++);

      schedule.push({minute: m + p*periodLength, in: subsIn, out: subsOut, gk});
    }
  }

  displaySchedule(schedule, playerData, players);
}

function displaySchedule(schedule, playerData, players){
  const schedDiv = document.getElementById("schedule");
  schedDiv.innerHTML = '';
  schedule.forEach(s=>{
    let div = document.createElement("div");
    let inNames = s.in.map(i=>players[i]);
    let outNames = s.out.map(i=>players[i]);
    let str = `<strong>Minut ${s.minute}:</strong> GK=${players[s.gk]} `;
    if(inNames.length>0) str += `<span class="arrow green">↑ ${inNames.join(", ")}</span> `;
    if(outNames.length>0) str += `<span class="arrow red">↓ ${outNames.join(", ")}</span>`;
    div.innerHTML = str;
    schedDiv.appendChild(div);
  });

  // Summering
  const sumDiv = document.getElementById("summary");
  let table = '<table class="summary-table"><tr><th>Spelare</th><th>Utespelartid (min)</th><th>Målvaktstid (min)</th></tr>';
  playerData.forEach(pd=>{
    table += `<tr><td>${pd.name}</td><td>${pd.totalPlay}</td><td>${pd.gkMinutes}</td></tr>`;
  });
  table += '</table>';
  sumDiv.innerHTML = table;
}

// Initiera
createPlayerInputs();
</script>
</body>
</html>
